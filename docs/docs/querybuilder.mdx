# QueryBuilder
> Description - How to use QueryBuilder to build effective queries with Couchbase Lite on Dart <br />
> Related Content -  LiveQueries | Indexing

:::note
The examples used in this topic are based on the Travel Sample app and data introduced in the [Couchbase Mobile Workshop](https://docs.couchbase.com/tutorials/mobile-travel-tutorial/introduction.html) tutorial
:::

## Introduction

Couchbase Lite for Dart provides two ways to build and run database queries; the QueryBuilder API described in this topic and the SQL++ for Mobile.

Database queries defined with the QueryBuilder API use query statements of the form shown in Example 1. The structure and semantics of the query format are based on that of Couchbase’s SQL++ query language.

###### Example 1 - Query Format 

```sql
SELECT ____ 
FROM 'database' 
WHERE ____, 
JOIN ____ 
GROUP BY ____ 
ORDER BY ____ 
```
**Query Components**
1. The **SELECT** statement specifies the document properties that will be returned in the result set
2. **FROM** specifies the database to query the documents from
3. **WHERE** statement specifies the query criteria.
The `SELECT`ed properties of documents matching this criteria will be returned in the result set
4. **JOIN** statement specifies the criteria for joining multiple documents
5. **GROUP BY** statement specifies the criteria used to group returned items in the result set
6. **ORDER BY** statement specifies the criteria used to order the items in the result set

## Indexing 

Before we begin querying documents, let’s briefly mention the importance of having a query index. A query can only be fast if there’s a pre-existing database index it can search to narrow down the set of documents to examine — see: Example 2, which shows how to create an index, and also the Query Troubleshooting topic.

However, every index has to be updated whenever a document is updated. So too many indexes can hurt performance.

Good performance depends on designing and creating the right indexes to go along with your queries.

###### Example 2 - Creating a New Index

```dart 
final documentTypeExpression =
  Expression.property('type');

final valueIndexItem = 
  ValueIndexItem.expression(documentTypeExpression);

final index = IndexBuilder.valueIndex(valueIndexItem);

await database.createIndex('index_name', index);
```

###### Data Model 

```json 
[
  { 
    "id": "hotel123",
    "type": "hotel",
    "name": "Hotel Ghia"
  },
  { 
    "id": "hotel456",
    "type": "hotel",
    "name": "Hotel Deluxe",
  }
]
```
## SELECT statement

Use the SELECT statement to specify which properties you want to return from the queried documents. You can opt to retrieve entire documents, or just the specific properties you need.

### Return All Properties
Use the [SelectResult.all](https://pub.dev/documentation/cbl/latest/cbl/SelectResult/all.html) method to return all the properties of selected documents — see: Example 3.

###### Example 3 - Using SELECT to Retrieve All Properties

```dart showLineNumbers
var query = QueryBuilder.createAsync();
query
 .select(SelectResult.all())
 .from(DataSource.database(database))
 .where(
	Expression.property('type')
	 .equalTo(Expression.string('hotel')));

var result = await query.execute();
```

The query.execute statement returns the results in a dictionary, where the key is the database name — see Example 4.

###### Example 4 - ResultSet Format from SelectResult.all()
```json
[
  {
    "travel-sample": { 
      "callsign": "MILE-AIR",
      "country": "United States",
      "iata": "Q5",
      "icao": "MLA",
      "id": 10,
      "name": "40-Mile Air",
      "type": "airline"
    }
  },
  {
    "travel-sample": { 
      "callsign": "ALASKAN-AIR",
      "country": "United States",
      "iata": "AA",
      "icao": "AAA",
      "id": 10,
      "name": "Alaskan Airways",
      "type": "airline"
    }
  }
]
```

### Return Selected Properties

To access only specific properties, specify a comma separated list of SelectResult expressions, one for each property, in the select statement of your query  — see: Example 5

###### Example 4 - Using SELECT to Retrieve Specific Properties

```dart showLineNumbers
var query = QueryBuilder.createAsync();

var results = query
 .select(
   SelectResult.expression(Meta.id),
   SelectResult.property('name'),
   SelectResult.property('type'))
 .from(DataSource.database(database))
 .where(
   Expression.property('type')
   .equalTo(Expression.string('hotel')))
 .orderBy(Ordering.expression(Meta.id))
 .execute();

var rs = await results.allResults();
for (var result in rs){
 debugPrint('hotel id-> ${result.string('id')}');
 debugPrint('hotel name-> ${result.string('name')}');
 debugPrint('hotel type-> ${result.string('type')}');
}

var queryTwo = QueryBuilder.createAsync();
var resultsTwo = queryTwo
 .select(
   SelectResult.expression(Meta.id),
   SelectResult.property('country'),
   SelectResult.property('name'))
 .from(DataSource.database(database))
 .execute();
var rsTwo = await resultsTwo.allResults();
for (var result in rsTwo){
 debugPrint('hotel name-> ${result.string('name')} in country-> ${result.string('country')}');
}
```

The query.execute statement returns one or more key-value pairs, one for each SelectResult expression, with the property-name as the key — see Example 6

###### Example 6 - Select Result Format
```json
[
  { 
    "id": "hotel123",
    "type": "hotel",
    "name": "Hotel Ghia"
  },
  { 
    "id": "hotel456",
    "type": "hotel",
    "name": "Hotel Deluxe",
  }
]
```

## WHERE Statement

Like SQL, you can use the WHERE statement to choose which documents are returned by your query. The select statement takes in an Expression. You can chain any number of Expressions in order to implement sophisticated filtering capabilities.

### Comparison Operators

The [Expression Comparators](https://pub.dev/documentation/cbl/latest/cbl/Expression-class.html) can be used in the WHERE statement to specify on which property to match documents. In  Example 7, we use the equalTo operator to query documents where the type property equals "hotel".

###### Example 7 - Using Where

```dart showLineNumbers
var query = QueryBuilder.createAsync();

var results = query
 .select(SelectResult.all())
 .from(DataSource.database(database))
 .where(
   Expression.property('type')
   .equalTo(Expression.string('hotel')))
 .limit(Expression.intValue(10))
 .execute();

var rs = await results.allResults();
for (var result in rs){
 debugPrint('hotel name-> ${result.string('name')}');
 debugPrint('hotel type-> ${result.string('type')}');
}

```

### Collection Operators

[Array Collection](https://pub.dev/documentation/cbl/latest/cbl/ArrayExpression-class.html) Operators are useful to check if a given value is present in an array.

#### CONTAINS Operator
The following example uses the [ArrayFunction](https://pub.dev/documentation/cbl/latest/cbl/ArrayFunction-class.html) to find documents where the public_likes array property contains a value equal to "Armani Langworth".

```json
{
 "_id": "hotel123",
 "name": "Apple Droid",
 "public_likes": 
 [
   "Armani Langworth", 
   "Elfrieda Gutkowski", 
   "Maureen Ruecker"
 ]
}

```

```dart showLineNumbers
var query = QueryBuilder.createAsync();

var results = await query
 .select(
  SelectResult.expression(Meta.id),
  SelectResult.property('name'),
  SelectResult.property('public_likes'))
 .from(DataSource.database(database))
 .where(
  Expression.property('type')
   .equalTo(Expression.string('hotel'))
 .and(
  ArrayFunction.contains(
   Expression.property('public_likes'),
    value: Expression.string('Armani Langworth'))))
 .execute();

var rs = await results.allResults();
debugPrint('public likes:');
for (var result in  rs){
 result.array('public_likes')?.toSet().map((e) => 
 {
  debugPrint(e.toString())  
 });
}
```

#### IN Operator

The IN operator is useful when you need to explicitly list out the values to test against. The following example looks for documents whose first, last or username property value equals "Armani".

:::caution
The IN operator uses the method name `.in_` due to `in` being a keyword in Dart.
::: 

```dart showLineNumbers
var values = [
 Expression.property('first'), 
 Expression.property('last'),
 Expression.property('username'),
];

var query = QueryBuilder.createAsync();
var results = await query
 .select(SelectResult.all())
 .from(DataSource.database(database))
 .where(
  Expression.string('Armani')
  .in_(values))
 .execute();
```

### Like Operator

The [like](https://pub.dev/documentation/cbl/latest/cbl/ExpressionInterface/like.html) operator can be used for string matching — see Example 8.

:::caution
The like operator performs case sensitive matches.
To perform case insensitive matching, use `Function_.lower` or `Function_.upper` to ensure all comparators have the same case, thereby removing the case issue.

Because Funtion is a keyword in Dart, the method name is `Function_`.
:::

This query returns landmark type documents where the name matches the string "Royal Engineers Museum", regardless of how it is capitalized (so, it selects "royal engineers museum", "ROYAL ENGINEERS MUSEUM" and so on).

###### Example 8 - Like with case-insensitive matching

```dart showLineNumbers
var query = QueryBuilder.createAsync();
var results = await query
 .select(
  SelectResult.expression(Meta.id),
  SelectResult.property('country'),
  SelectResult.property('name'))
 .from(DataSource.database(database))
 .where(
  Expression.property('type').equalTo(Expression.string('landmark'))
  .and(Function_.lower(
	Expression.property('name')
	 .like(Expression.string('royal engineers museum')))))
 .execute();

var rs = await results.allResults();
for (var result in  rs){
	debugPrint('name property-> ${result.string('name')}');
}
```

:::note
`Function_.lower` will transform name values to the same case as the literal comparator.
:::

#### Wildcard Match

We can use % sign within a like expression to do a wildcard match against zero or more characters. Using wildcards allows you to have some fuzziness in your search string.

In Example 9 below, we are looking for documents of type "landmark" where the name property matches any string that begins with "eng" followed by zero or more characters, the letter "e", followed by zero or more characters. Once again, we are using `Function_.lower` to make the search case insensitive.

So "landmark" documents with names such as "Engineers", "engine", "english egg" and "England Eagle". Notice that the matches may span word boundaries.

###### Example 9 - Wildcard Matches 

```dart showLineNumbers
var query = QueryBuilder.createAsync();
var results = await query
 .select(
  SelectResult.expression(Meta.id),
  SelectResult.property('country'),
  SelectResult.property('name'))
 .from(DataSource.database(database))
 .where(
  Expression.property('type').equalTo(Expression.string('landmark'))
  .and(Function_.lower(
	Expression.property('name')
	 .like(Expression.string('eng%e%')))))
 .limit(Expression.intValue(10));
```

#### Wildcard Character Match

We can use an _ sign within a like expression to do a wildcard match against a single character.

In Example 10 below, we are looking for documents of type "landmark" where the name property matches any string that begins with "eng" followed by exactly 4 wildcard characters and ending in the letter "r". The query returns "landmark" type documents with names such as "Engineer", "engineer" and so on.

###### Example 10 - Wildcard Character Matching

```dart showLineNumbers
var query = QueryBuilder.createAsync();
var results = await query
 .select(
  SelectResult.expression(Meta.id),
  SelectResult.property('country'),
  SelectResult.property('name'))
 .from(DataSource.database(database))
 .where(
  Expression.property('type').equalTo(Expression.string('landmark'))
  .and(Function_.lower(
	Expression.property('name')
	 .like(Expression.string('eng____r')))))
 .limit(Expression.intValue(10));
```

### Regex Operator

Similar to the wildcards in like expressions, regex based pattern matching allow you to introduce an element of fuzziness in your search string — see the code shown in Example 11.

:::note
The `regex` operator is case sensitive, use `upper` or `lower` functions to mitigate this if required.
:::

This example returns documents with a `type` of "landmark" and a `name` property that matches any string that begins with "eng" and ends in the letter "e".

###### Example 11 - Using Regular Expressions

```dart showLineNumbers
var query = QueryBuilder.createAsync();
var results = await query
 .select(
  SelectResult.expression(Meta.id),
  SelectResult.property('country'),
  SelectResult.property('name'))
 .from(DataSource.database(database))
 .where(
  Expression.property('type').equalTo(Expression.string('landmark'))
  .and(Expression.property('name')
	 .regex(Expression.string('\\bEng.*e\\b'))))
 .limit(Expression.intValue(10));
```
:::note
The \b specifies that the match must occur on word boundaries.
:::

:::tip
For more on the regex spec used by Couchbase Lite see [cplusplus regex reference page](https://cplusplus.com/reference/regex/ECMAScript/).
:::

### Deleted Document

You can query documents that have been deleted (`tombstones`) as shown in Example 12.

This example shows how to query deleted documents in the database. It returns is an array of key-value pairs.

###### Example 12 - Query to select Deleted Documents

```dart showLineNumbers
var query = QueryBuilder.createAsync();
var results = await query
 .select(SelectResult.expression(Meta.id))
 .from(DataSource.database(database))
 .where(Meta.isDeleted)
 .execute();
```

## JOIN statement
The JOIN clause enables you to select data from multiple documents that have been linked by criteria specified in the JOIN statement. For example to combine airline details with route details, linked by the airline id — see Example 13.

This example JOINS the document of type route with documents of type airline using the document ID (`id`) on the `airline` document and `airlineid` on the `route` document.

###### Example 13 - Using JOIN to Combine Document Details
```dart showLineNumbers

```
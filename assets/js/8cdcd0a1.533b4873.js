"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[429],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(n),c=r,m=d["".concat(s,".").concat(c)]||d[c]||h[c]||i;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:r,o[1]=l;for(var u=2;u<i;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},9092:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>y,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));const i={description:"Couchbase Lite Queries \u2014 Troubleshooting",abstract:"This content describes how to use the Couchbase Lite for Dart Query API's explain method to examine a query.",related_content:[{name:"Live Queries",url:"/queries/live-queries"},{name:"Indexing",url:"/indexing"}]},o="Query Troubleshooting",l={unversionedId:"queries/query-troubleshooting",id:"queries/query-troubleshooting",title:"Query Troubleshooting",description:"Couchbase Lite Queries \u2014 Troubleshooting",source:"@site/docs/queries/query-troubleshooting.mdx",sourceDirName:"queries",slug:"/queries/query-troubleshooting",permalink:"/queries/query-troubleshooting",draft:!1,editUrl:"https://github.com/cbl-dart/cbl-dart/tree/main/docs/docs/queries/query-troubleshooting.mdx",tags:[],version:"current",frontMatter:{description:"Couchbase Lite Queries \u2014 Troubleshooting",abstract:"This content describes how to use the Couchbase Lite for Dart Query API's explain method to examine a query.",related_content:[{name:"Live Queries",url:"/queries/live-queries"},{name:"Indexing",url:"/indexing"}]},sidebar:"sidebar",previous:{title:"Live Queries",permalink:"/queries/live-queries"},next:{title:"Using Full-Text Search",permalink:"/full-text-search"}},s={},u=[{value:"Query Explain",id:"query-explain",level:2},{value:"Using",id:"using",level:3},{value:"Output",id:"output",level:3},{value:"The Query Plan",id:"the-query-plan",level:2},{value:"Format",id:"format",level:3},{value:"Retrieval Method",id:"retrieval-method",level:3},{value:"Order and Group",id:"order-and-group",level:3},{value:"Queries and Indexes",id:"queries-and-indexes",level:2},{value:"Working with the Query Optimizer",id:"working-with-the-query-optimizer",level:2},{value:"Wildcard and Like-based Queries",id:"wildcard-queries",level:2},{value:"Use Functions Wisely",id:"use-functions-wisely",level:2},{value:"Optimization Considerations",id:"optimization-considerations",level:2}],p=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",t)},d=p("CodeExample"),h=p("Table"),c={toc:u},m="wrapper";function y(e){let{components:t,...n}=e;return(0,r.kt)(m,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"query-troubleshooting"},"Query Troubleshooting"),(0,r.kt)("metaheader",null),(0,r.kt)("h2",{id:"query-explain"},"Query Explain"),(0,r.kt)("h3",{id:"using"},"Using"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://pub.dev/documentation/cbl/latest/cbl/Query/explain.html"},(0,r.kt)("inlineCode",{parentName:"a"},"Query.explain()"))," method can provide useful insight when you are trying\nto diagnose query performance issues and-or optimize queries. To examine how\nyour query is working, either embed the call inside your app (see:\n",(0,r.kt)("a",{parentName:"p",href:"#example-1"},"Example 1"),"), or use it interactively within a cblite shell (see:\n",(0,r.kt)("a",{parentName:"p",href:"#example-2"},"Example 2"),")."),(0,r.kt)(d,{id:1,title:"Using Query Explain in App",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"final database = await Database.openAsync('hotels');\nfinal query = const QueryBuilder()\n  .select(\n    SelectResult.expression(Meta.id).as('docId'),\n    SelectResult.expression(Expression.property('id')),\n    SelectResult.expression(Expression.property('name')),\n    SelectResult.expression(Expression.property('city')),\n    SelectResult.expression(Expression.property('type')),\n  )\n  .from(DataSource.database(database));\n\nprint(await query.explain());\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Construct your query as normal."),(0,r.kt)("li",{parentName:"ol"},"Call the query's ",(0,r.kt)("inlineCode",{parentName:"li"},"explain")," method and print it."))),(0,r.kt)(d,{id:2,title:"Using Query Explain in cblite",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cblite <your-database-name>.cblite2\n(cblite) select --explain domains GROUP BY country ORDER BY country, name\n(cblite) query --explain {"GROUP_BY":[[".country"]],"ORDER_BY":[[".country"],[".name"]],"WHAT":[[".domains"]]}\n')),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Within a terminal session open your database with cblite and enter your\nquery."),(0,r.kt)("li",{parentName:"ol"},"Here the query is entered as a SQL++-query using select."),(0,r.kt)("li",{parentName:"ol"},"Here the query is entered as a JSON-string using query."))),(0,r.kt)("h3",{id:"output"},"Output"),(0,r.kt)("p",null,"The output from ",(0,r.kt)("a",{parentName:"p",href:"https://pub.dev/documentation/cbl/latest/cbl/Query/explain.html"},(0,r.kt)("inlineCode",{parentName:"a"},"Query.explain()"))," remains the same whether invoked by an\napp, or cblite \u2014 see ",(0,r.kt)("a",{parentName:"p",href:"#example-3"},"Example 3")," for an example of how it looks."),(0,r.kt)(d,{id:3,title:"Query.explain() Output",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'SELECT fl_result(fl_value(_doc.body, \'domains\')) FROM kv_default AS _doc WHERE (_doc.flags & 1 = 0) GROUP BY fl_value(_doc.body, \'country\') ORDER BY fl_value(_doc.body, \'country\'), fl_value(_doc.body, \'name\')\n\n7|0|0| SCAN TABLE kv_default AS _doc\n12|0|0| USE TEMP B-TREE FOR GROUP BY\n52|0|0| USE TEMP B-TREE FOR ORDER BY\n\n{"GROUP_BY":[[".country"]],"ORDER_BY":[[".country"],[".name"]],"WHAT":[[".domains"]]}\n')),(0,r.kt)("p",null,"This output (",(0,r.kt)("a",{parentName:"p",href:"#example-3"},"Example 3"),") comprises three main elements:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The translated SQL-query, which is not necessarily useful, being aimed more\nat Couchbase support and-or engineering teams."),(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("a",{parentName:"li",href:"https://www.sqlite.org/eqp.html"},"SQLite query plan"),", which gives a\nhigh-level view of how the SQL query will be implemented. You can use this to\nidentify potential issues and so optimize problematic queries."),(0,r.kt)("li",{parentName:"ol"},"The query in JSON-string format, which you can copy-and-paste directly into\nthe ",(0,r.kt)("em",{parentName:"li"},"cblite")," tool."))),(0,r.kt)("h2",{id:"the-query-plan"},"The Query Plan"),(0,r.kt)("h3",{id:"format"},"Format"),(0,r.kt)("p",null,"The query plan section of the output displays a tabular form of the translated\nquery's execution plan. It primarily shows how the data will be retrieved and,\nwhere appropriate, how it will be sorted for navigation and-or presentation\npurposes. For more on SQLite's Explain Query Plan \u2014 see:\n",(0,r.kt)("a",{parentName:"p",href:"https://www.sqlite.org/eqp.html"},"https://www.sqlite.org/eqp.html"),"."),(0,r.kt)(d,{id:4,title:"A Query Plan",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"7|0|0| SCAN TABLE kv_default AS _doc\n12|0|0| USE TEMP B-TREE FOR GROUP BY\n52|0|0| USE TEMP B-TREE FOR ORDER BY\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Retrieval method")," \u2014 This line shows the retrieval method being used for\nthe query; here a sequential read of the database. Something you may well be\nlooking to optimize \u2014 see ",(0,r.kt)("a",{parentName:"li",href:"#retrieval-method"},"Retrieval Method")," for more."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Grouping method")," --- This line shows that the ",(0,r.kt)("inlineCode",{parentName:"li"},"GROUP BY")," clause used in\nthe query requires the data to be sorted and that a b-tree will be used for\ntemporary storage \u2014 see ",(0,r.kt)("a",{parentName:"li",href:"#order-and-group"},"Order and Group"),"."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Ordering method")," \u2014 This line shows that the ",(0,r.kt)("inlineCode",{parentName:"li"},"ORDER BY")," clause used in the\nquery requires the data to be sorted and that a b-tree will be used for\ntemporary storage \u2014 see ",(0,r.kt)("a",{parentName:"li",href:"#order-and-group"},"Order and Group"),"."))),(0,r.kt)("h3",{id:"retrieval-method"},"Retrieval Method"),(0,r.kt)("p",null,"The query optimizer will attempt to retrieve the requested data items as\nefficiently as possible, which generally will be by using one or more of the\navailable indexes. The retrieval method shows the approach decided upon by the\noptimizer \u2014 see ",(0,r.kt)("a",{parentName:"p",href:"#table-1"},"Table 1"),"."),(0,r.kt)(h,{id:1,title:"Retrieval Methods",mdxType:"Table"},(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Retrieval Method"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Search"),(0,r.kt)("td",{parentName:"tr",align:"left"},"Here the query is able to access the required data directly using keys into the index. Queries using the Search mode are the fastest.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Scan Index"),(0,r.kt)("td",{parentName:"tr",align:"left"},"Here the query is able to retrieve the data by scanning all or part-of the index (for example when seeking to match values within a range). This type of query is slower than search, but at least benefits from the compact and ordered form of the index.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Scan Table"),(0,r.kt)("td",{parentName:"tr",align:"left"},"Here the query must scan the database table(s) to retrieve the required data. It is the slowest of these methods and will benefit most from some form of optimization."))))),(0,r.kt)("p",null,"When looking to optimize a query's retrieval method, consider whether:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Providing an additional index makes sense."),(0,r.kt)("li",{parentName:"ul"},"You could use an existing index \u2014 perhaps by restructuring the query to\nminimize wildcard use, or the reliance on functions that modify the query's\ninterpretation of index keys (for example, 'lower')."),(0,r.kt)("li",{parentName:"ul"},"You could reduce the data set being requested to minimize the query's\nfootprint on the database.")),(0,r.kt)("h3",{id:"order-and-group"},"Order and Group"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"USE TEMP B-TREE FOR")," lines in the example indicate that the query requires\nsorting to cater for grouping and then sorting again to present the output\nresults. Minimizing, if not eliminating, this ordering and re-ordering will\nobviously reduce the amount of time taken to process your query."),(0,r.kt)("p",null,'Ask "is the grouping and-or ordering absolutely necessary?": if it isn\'t, drop\nit or modify it to minimize its impact.'),(0,r.kt)("h2",{id:"queries-and-indexes"},"Queries and Indexes"),(0,r.kt)("p",null,"Before we begin querying documents, let's briefly mention the importance of\nhaving an appropriate and balanced approach to indexes."),(0,r.kt)("p",null,"Creating indexes can speed up the performance of queries. A query will typically\nreturn results more quickly if it can take advantage of an existing database\nindex to search, narrowing down the set of documents to be examined."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Couchbase Lite for dart does not currently support partial value indexes;\nindexes with non-property expressions. You should only index with properties\nthat you plan to use in the query.")),(0,r.kt)("p",null,"The Query optimizer converts your query into a parse tree that groups zero or\nmore ",(0,r.kt)("em",{parentName:"p"},"and-connected")," clauses together (as dictated by your where conditionals)\nfor effective query engine processing."),(0,r.kt)("p",null,"Ideally a query will be be able to satisfy its requirements entirely by either\ndirectly accessing the index or searching sequential index rows. Less good is if\nthe query must scan the whole index; although the compact nature of most indexes\nmeans this is still much faster than the alternative of scanning the entire\ndatabase with no help from the indexes at all."),(0,r.kt)("p",null,"Searches that begin with or rely upon an inequality with the primary key are\ninherently less effective than those using a primary key equality."),(0,r.kt)("h2",{id:"working-with-the-query-optimizer"},"Working with the Query Optimizer"),(0,r.kt)("p",null,"You may have noticed that sometimes a query runs faster on a second run, or\nafter re-opening the database, or after deleting and recreating an index. This\ntypically happens when SQL Query Optimizer has gathered sufficient stats to\nrecognize a means of optimizing a sub-optimal query."),(0,r.kt)("p",null,"If only those stats were available from the start. In fact they are gathered\nafter certain events, such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Following index creation"),(0,r.kt)("li",{parentName:"ul"},"On a database close"),(0,r.kt)("li",{parentName:"ul"},"When running a database compact.")),(0,r.kt)("p",null,"So, if your analysis of the ",(0,r.kt)("a",{parentName:"p",href:"#example-3"},"Query Explain output")," indicates a\nsub-optimal query and your rewrites fail to sufficiently optimize it, consider\ncompacting the database. Then re-generate the Query Explain and note any\nimprovements in optimization. They may not, in themselves, resolve the issue\nentirely; but they can provide a uesful guide toward further optimizing changes\nyou could make."),(0,r.kt)("h2",{id:"wildcard-queries"},"Wildcard and Like-based Queries"),(0,r.kt)("p",null,"Like-based searches can use the index(es) only if:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The search-string doesn't start with a wildcard."),(0,r.kt)("li",{parentName:"ul"},"The primary search expression uses a property that is an indexed key."),(0,r.kt)("li",{parentName:"ul"},"The search-string is a constant known at run time (that is, not a value\nderived during processing of the query).")),(0,r.kt)("p",null,"To illustrate this we can use a modified query; replacing a simple equality test\nwith a ",(0,r.kt)("inlineCode",{parentName:"p"},"LIKE"),"."),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"#example-5"},"Example 5")," we use a wildcard prefix and suffix. You can see that the\nquery plan decides on a retrieval method of ",(0,r.kt)("inlineCode",{parentName:"p"},"SCAN TABLE"),"."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"For more on indexes \u2014\u2009see: ",(0,r.kt)("a",{parentName:"p",href:"/indexing"},"Indexing"),".")),(0,r.kt)(d,{id:5,title:"Like with Wildcard Prefix",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"final database = await Database.openAsync('hotels');\nfinal query = const QueryBuilder()\n  .select(SelectResult.all())\n  .from(DataSource.database(database).as('item'))\n  .where(Expression.property('type').like(Expression.string('%hotel%')));\n\nprint(await query.explain());\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The indexed property, ",(0,r.kt)("inlineCode",{parentName:"li"},"type"),", cannot use its index because of the wildcard\nprefix."))),(0,r.kt)(d,{id:6,title:"Resulting Query Plan",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-console"},"2|0|0| SCAN TABLE kv_default AS _doc\n"))),(0,r.kt)("p",null,"By contrast, by removing the wildcard prefix ",(0,r.kt)("inlineCode",{parentName:"p"},"%")," (in ",(0,r.kt)("a",{parentName:"p",href:"#example-7"},"Example 7"),"), we see\nthat the query plan's retrieval method changes to become an index search. Where\npractical, simple changes like this can make significant differences in query\nperformance."),(0,r.kt)(d,{id:7,title:"Like with No Wildcard-prefix",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"final database = await Database.openAsync('hotels');\nfinal query = const QueryBuilder()\n  .select(SelectResult.all())\n  .from(DataSource.database(database).as('item'))\n  .where(Expression.property('type').like(Expression.string('hotel%'))\n    .and(Expression.property('name').like(Expression.string('%royal%'))));\n\nprint(await query.explain());\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Simply removing the wildcard prefix enables the query optimizer to access the\n",(0,r.kt)("inlineCode",{parentName:"li"},"typeIndex"),", which results in a more efficient search."))),(0,r.kt)(d,{id:8,title:"Resulting Query Plan",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-console"},"3|0|0| SEARCH TABLE kv_default AS _doc USING INDEX typeIndex (<expr>>? AND <expr><?)\n"))),(0,r.kt)("h2",{id:"use-functions-wisely"},"Use Functions Wisely"),(0,r.kt)("p",null,"Functions are a very useful tool in building queries, but be aware that they can\nimpact whether the query-optimizer is able to use your index(es)."),(0,r.kt)("p",null,"For example, you can observe a similar situation to that shown in\n",(0,r.kt)("a",{parentName:"p",href:"#wildcard-queries"},"Wildcard and Like-based Queries")," when using\n",(0,r.kt)("a",{parentName:"p",href:"https://pub.dev/documentation/cbl/latest/cbl/Function_/lower.html"},(0,r.kt)("inlineCode",{parentName:"a"},"Function_.lower()"))," on an indexed property."),(0,r.kt)(d,{id:9,title:"WHERE with LOWER Function",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"final database = await Database.openAsync('hotels');\nfinal query = const QueryBuilder()\n  .select(SelectResult.all())\n  .from(DataSource.database(database))\n  .where(Function_.lower(Expression.property('type')).equalTo(Expression.string('hotel')));\n\nprint(await query.explain());\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Here we use ",(0,r.kt)("a",{parentName:"li",href:"https://pub.dev/documentation/cbl/latest/cbl/Function_/lower.html"},(0,r.kt)("inlineCode",{parentName:"a"},"Function_.lower()"))," in the ",(0,r.kt)("inlineCode",{parentName:"li"},"WHERE")," expression."))),(0,r.kt)(d,{id:10,title:"Resulting Query Plan",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-console"},"2|0|0| SCAN TABLE kv_default AS _doc\n"))),(0,r.kt)("p",null,"But removing ",(0,r.kt)("a",{parentName:"p",href:"https://pub.dev/documentation/cbl/latest/cbl/Function_/lower.html"},(0,r.kt)("inlineCode",{parentName:"a"},"Function_.lower()")),", changes things:"),(0,r.kt)(d,{id:11,title:"WHERE with LOWER Function",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dart"},"final database = await Database.openAsync('hotels');\nfinal query = const QueryBuilder()\n  .select(SelectResult.all())\n  .from(DataSource.database(database))\n  .where(Expression.property('type').equalTo(Expression.string('hotel')));\n\nprint(await query.explain());\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Here we have removed ",(0,r.kt)("a",{parentName:"li",href:"https://pub.dev/documentation/cbl/latest/cbl/Function_/lower.html"},(0,r.kt)("inlineCode",{parentName:"a"},"Function_.lower()"))," from the ",(0,r.kt)("inlineCode",{parentName:"li"},"WHERE")," expression."))),(0,r.kt)(d,{id:12,title:"Query Plan",mdxType:"CodeExample"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-console"},"3|0|0| SEARCH TABLE kv_default AS _doc USING INDEX typeIndex (<expr>=?)\n"))),(0,r.kt)("p",null,"Knowing this, you can consider how you create the index; for example, using\n",(0,r.kt)("a",{parentName:"p",href:"https://pub.dev/documentation/cbl/latest/cbl/Function_/lower.html"},(0,r.kt)("inlineCode",{parentName:"a"},"Function_.lower()"))," when you create the index and then always using\nlowercase comparisons."),(0,r.kt)("h2",{id:"optimization-considerations"},"Optimization Considerations"),(0,r.kt)("p",null,"Try to minimize the amount of data retrieved. Reduce it down to the few\nproperties you really do need to achieve the required result."),(0,r.kt)("p",null,"Consider fetching details lazily. You could break complex queries into\ncomponents. Returning just the document IDs, then process the array of document\nIDs using either the Document API or a query thats uses the array of document\nIDs to return information."),(0,r.kt)("p",null,"Consider using paging to minimize the data returned when the number of results\nreturned is expected to be high. Getting the whole lot at once will be slow and\nresource intensive: Plus does anyone want to access them all in one go? Instead\nretrieve batches of information at a time, perhaps using ",(0,r.kt)("inlineCode",{parentName:"p"},"LIMIT")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"OFFSET"),"\nclauese to set a starting point for each subsequent batch."),(0,r.kt)("p",null,"Although, note that using query offsets becomes increasingly less effective as\nthe overhead of skipping a growing number of rows each time increases. You can\nwork around this, by instead using ranges of search-key values. If the last\nsearch-key value of batch one was 'x' then that could become the starting point\nfor your next batch and-so-on."),(0,r.kt)("p",null,"Optimize document size in design. Smaller documents load more quickly. Break\nyour data into logical linked units."),(0,r.kt)("p",null,"Consider Using Full Text Search instead of complex ",(0,r.kt)("inlineCode",{parentName:"p"},"LIKE")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"REGEX")," patterns \u2014\nsee ",(0,r.kt)("a",{parentName:"p",href:"/full-text-search"},"Full Text Search"),"."))}y.isMDXComponent=!0}}]);